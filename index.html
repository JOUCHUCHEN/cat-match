function dragEnd(e) {
  if (!clone) return;
  const x = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
  const y = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
  const dropCell = document.elementFromPoint(x, y);
  if (!dropCell || !dropCell.classList.contains("cell")) {
    // 平滑回原位
    animateReturn(clone, startRow, startCol);
    clone = null;
    return;
  }
  const endRow = +dropCell.dataset.row;
  const endCol = +dropCell.dataset.col;

  const dr = Math.abs(endRow - startRow);
  const dc = Math.abs(endCol - startCol);

  if ((dr + dc) === 1) {
    swapCells(startRow, startCol, endRow, endCol);
    const matches = checkMatches();
    if (matches.length > 0) {
      handleMatches(matches);
      clone.remove();
    } else {
      // 滑錯回原位
      swapCells(startRow, startCol, endRow, endCol);
      animateReturn(clone, startRow, startCol);
    }
  } else {
    // 非鄰格，回原位
    animateReturn(clone, startRow, startCol);
  }

  document.removeEventListener("mousemove", dragMove);
  document.removeEventListener("mouseup", dragEnd);
  document.removeEventListener("touchmove", dragMove);
  document.removeEventListener("touchend", dragEnd);
}

// 平滑回原位動畫
function animateReturn(cloneEl, r, c) {
  const targetCell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
  if (!targetCell) { cloneEl.remove(); return; }
  const rect = targetCell.getBoundingClientRect();
  cloneEl.style.transition = "all 0.3s ease";
  cloneEl.style.left = rect.left + "px";
  cloneEl.style.top = rect.top + "px";
  setTimeout(() => cloneEl.remove(), 310); // 動畫結束後移除 clone
}
