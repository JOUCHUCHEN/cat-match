<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å–µå—šæ¶ˆæ¶ˆæ¨‚</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Chiron+GoRound+TC:wght@200..900&family=Gluten:wght@100..900&family=Labrada:ital,wght@0,100..900;1,100..900&family=Lexend+Deca:wght@100..900&family=Tomorrow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
body {
  text-align: center;
  background: #8FC7FF;
  color: #fff;
  font-family: 'Zen Maru Gothic', sans-serif; /* ä½¿ç”¨ Zen Maru Gothic */
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}
#game {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  grid-template-rows: repeat(8, 1fr);
  gap: 1.2vw;
  justify-content: center;
  width: 90vw;
  max-width: 480px;
  aspect-ratio: 1/1;
  margin: 20px auto;
  position: relative;
  touch-action: none;
}
.cell {
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  border-radius: 10%;
  cursor: grab;
  position: relative;
  transition: transform 0.5s ease, background-image 0.5s ease;
}
.cell.dragging {
  transform: scale(1.2);
  z-index: 10;
}
.score {
  font-size: 5vw;
  margin-top: 2vw;
}
.plus-text {
  position: fixed;
  font-size: 4vw;
  color: #ffdd00;
  font-weight: bold;
  animation: floatUp 0.8s ease-out forwards;
  pointer-events: none;
}
@keyframes floatUp {
  0% {opacity:1; transform:translateY(0);}
  100% {opacity:0; transform:translateY(-40px);}
}
@media (min-width: 600px) {
  .score { font-size: 22px; }
  .plus-text { font-size: 18px; }
}

h2 {
  font-size: 6vw;      /* æ‰‹æ©Ÿç‰ˆå­—é«”æ”¾å¤§ï¼Œ6% çš„è¢å¹•å¯¬åº¦ */
  margin-top: 1vw;     /* ä¸Šæ–¹é–“è· */
  margin-bottom: 0vw;  /* ä¸‹æ–¹é–“è· */
  font-weight: bold;   /* æ–‡å­—åŠ ç²— */
}
@media (min-width: 600px) {
  h2 {
    font-size: 36px;   /* æ¡Œé¢ç‰ˆå›ºå®šå­—é«”å¤§å° */
  }
}

</style>
</head>
<body>

<h2>Meow Meow æ¶ˆæ¶ˆæ¨‚</h2>
<div class="score">å–µå—šå€¼ï¼š<span id="score">0</span></div>
<div id="game"></div>

<script>

let soundUnlocked = false;

function unlockSounds() {
  if(!soundUnlocked){
  const sound = clearSound.cloneNode();
  sound.volume = 0;
  sound.play().catch(()=>{});
  sound.pause();
  soundUnlocked = true;
}
}

function playMoveSound(){
  const sound = moveSound.cloneNode(); // æ¯æ¬¡ç”Ÿæˆæ–°ç‰©ä»¶
  sound.volume = 1;
  sound.currentTime = 0;
  sound.play().catch(()=>{}); // æ•æ‰æ’­æ”¾éŒ¯èª¤
}

function playClearSound(){
  if(!soundUnlocked) return;
  const sound = clearSound.cloneNode();
  sound.volume = 1;
  sound.currentTime = 0;
  setTimeout(() => {
    sound.play().catch(()=>{});
  }, 0);
}

const rows = 8, cols = 8;
const icons = ["img/1.png","img/2.png","img/3.png","img/4.png","img/5.png","img/6.png","img/7.png"];
let board = [];
let score = 0;

const game = document.getElementById("game");
const moveSound = new Audio("sound/button-click-289742.mp3");
moveSound.preload = "auto";
moveSound.volume = 1.0; // éŸ³é‡æœ€å¤§ 1.0

const clearSound = new Audio("sound/real_record_cat_meow_v2_C4.wav");
clearSound.preload = "auto";
clearSound.volume = 1.0;

const scoreEl = document.getElementById("score");

function randomIcon() {
  return icons[Math.floor(Math.random() * icons.length)];
}

// åˆå§‹åŒ–æ£‹ç›¤
function initBoard() {
  do {
    board = [];
    for (let r = 0; r < rows; r++) {
      const row = [];
      for (let c = 0; c < cols; c++) {
        row.push(randomIcon());
      }
      board.push(row);
    }
  } while (checkMatches(true).length > 0);
  renderBoard();
}

// æ¸²æŸ“æ£‹ç›¤
function renderBoard() {
  game.innerHTML = "";
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.style.backgroundImage = `url("${board[r][c]}")`;
      cell.dataset.row = r;
      cell.dataset.col = c;
      addDragEvents(cell);
      game.appendChild(cell);
    }
  }
}

let startRow, startCol, currentCell;

function addDragEvents(cell) {
  cell.addEventListener("mousedown", dragStart);
  cell.addEventListener("touchstart", dragStart, {passive:false});
}

function dragStart(e) {
  e.preventDefault();

  unlockSounds(); // ğŸ”‘ å…ˆè§£é–éŸ³æ•ˆ

  playMoveSound();

  currentCell = e.target;
  currentCell.classList.add("dragging");
  startRow = +currentCell.dataset.row;
  startCol = +currentCell.dataset.col;

  document.addEventListener("mousemove", dragMove);
  document.addEventListener("mouseup", dragEnd);
  document.addEventListener("touchmove", dragMove, {passive:false});
  document.addEventListener("touchend", dragEnd);
}

function dragMove(e) {
  if (!currentCell) return;
  const x = e.touches ? e.touches[0].clientX : e.clientX;
  const y = e.touches ? e.touches[0].clientY : e.clientY;
  const over = document.elementFromPoint(x, y);
  if (!over || !over.classList.contains("cell")) return;

  const endRow = +over.dataset.row;
  const endCol = +over.dataset.col;
  const dr = Math.abs(endRow - startRow);
  const dc = Math.abs(endCol - startCol);

  if ((dr + dc) === 1) {
    swapCells(startRow, startCol, endRow, endCol, () => {
      const groups = checkMatches(true);
      if (groups.length > 0) handleMatches(groups, 1);
      else swapCells(startRow, startCol, endRow, endCol);
    });
    dragEnd();
  }
}

function dragEnd() {
  if (currentCell) currentCell.classList.remove("dragging");
  currentCell = null;
  document.removeEventListener("mousemove", dragMove);
  document.removeEventListener("mouseup", dragEnd);
  document.removeEventListener("touchmove", dragMove);
  document.removeEventListener("touchend", dragEnd);
}

// äº¤æ›å‹•ç•«
function swapCells(r1, c1, r2, c2, callback) {

  const cell1 = document.querySelector(`.cell[data-row="${r1}"][data-col="${c1}"]`);
  const cell2 = document.querySelector(`.cell[data-row="${r2}"][data-col="${c2}"]`);
  if (!cell1 || !cell2) return;

  const dx = c2 - c1;
  const dy = r2 - r1;
  const moveX = dx * cell1.offsetWidth;
  const moveY = dy * cell1.offsetHeight;

  cell1.style.transition = "transform 0.25s ease";
  cell2.style.transition = "transform 0.25s ease";
  cell1.style.transform = `translate(${moveX}px, ${moveY}px)`;
  cell2.style.transform = `translate(${-moveX}px, ${-moveY}px)`;

  setTimeout(() => {
    cell1.style.transition = "";
    cell2.style.transition = "";
    cell1.style.transform = "";
    cell2.style.transform = "";
    [board[r1][c1], board[r2][c2]] = [board[r2][c2], board[r1][c1]];
    renderBoard();
    if (callback) callback();
  }, 250);
}

// æª¢æŸ¥æ¶ˆé™¤ï¼Œå›å‚³ç¾¤çµ„
function checkMatches(returnGroups=false){
  const groups = [];

  for (let r=0;r<rows;r++){
    let count=1;
    for(let c=1;c<cols;c++){
      if(board[r][c]===board[r][c-1]) count++;
      else { if(count>=3){ groups.push([...Array(count).keys()].map(k=>[r,c-count+k])); } count=1; }
    }
    if(count>=3) groups.push([...Array(count).keys()].map(k=>[r,cols-count+k]));
  }

  for(let c=0;c<cols;c++){
    let count=1;
    for(let r=1;r<rows;r++){
      if(board[r][c]===board[r-1][c]) count++;
      else{ if(count>=3){ groups.push([...Array(count).keys()].map(k=>[r-count+k,c])); } count=1; }
    }
    if(count>=3) groups.push([...Array(count).keys()].map(k=>[rows-count+k,c]));
  }

  return returnGroups ? groups : groups.flat();
}

// æ¸…é™¤ç¾¤çµ„+åˆ†æ•¸å‹•ç•«
function clearMatches(groups, combo=1){
  if(groups.length > 0){
  playClearSound();
}

  // åŸæœ¬çš„æ¸…é™¤å’ŒåŠ åˆ†ç¨‹å¼ç¢¼
  const flat = groups.flat().map(([r,c]) => r + "-" + c);
  const overlapCount = flat.filter((v,i,a) => a.indexOf(v) !== i).length;

  groups.forEach(group=>{
    let singleScore = 0;
    const len = group.length;

    if(len===3) singleScore = 1;
    else if(len===4) singleScore = 2;
    else if(len>=5) singleScore = 3;

    if (overlapCount > 0) singleScore = 2;

    group.forEach(([r,c])=>{
      board[r][c] = null;
      showPlusEffect(r, c, singleScore);
      score += singleScore * combo;
    });
  });

  scoreEl.textContent = score;
}

// é¡¯ç¤º +åˆ†æ•¸ å‹•ç•«
function showPlusEffect(r,c,points){
  const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
  if(!cell) return;
  const rect = cell.getBoundingClientRect();
  const plus = document.createElement("div");
  plus.classList.add("plus-text");
  plus.textContent = `+${points}`; // é¡¯ç¤ºå–®æ ¼åˆ†æ•¸
  plus.style.left = rect.left + "px";
  plus.style.top = rect.top + "px";
  document.body.appendChild(plus);
  setTimeout(()=>plus.remove(),800);
}

// é‡åŠ›ä¸‹è½
function applyGravity(){
  let moved=false;
  for(let c=0;c<cols;c++){
    for(let r=rows-1;r>=0;r--){
      if(board[r][c]===null){
        let upper=r-1;
        while(upper>=0 && board[upper][c]===null) upper--;
        if(upper>=0){ board[r][c]=board[upper][c]; board[upper][c]=null; moved=true; }
      }
    }
  }
  renderBoard();
  return moved;
}

// è£œæ»¿æ£‹ç›¤
function refillBoard(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(board[r][c]===null) board[r][c]=randomIcon();
    }
  }
  renderBoard();
}

// è™•ç†æ¶ˆé™¤+é€£é–
function handleMatches(groups, combo=1){
  clearMatches(groups, combo);
  setTimeout(()=>{
    const moved = applyGravity();
    setTimeout(()=>{
      refillBoard();
      const newGroups = checkMatches(true);
      if(newGroups.length>0) handleMatches(newGroups, combo+1);
      else if(!hasPossibleMoves()) {
        alert("æ²’æœ‰å¯ç§»å‹•çµ„åˆï¼Œé‡æ–°æ´—ç‰Œï¼");
        score = 0;
        scoreEl.textContent = score;
        initBoard(); // é‡æ–°ç”Ÿæˆæ£‹ç›¤
      }
    }, moved? 250:0);
  },350);
}


// æª¢æŸ¥æ˜¯å¦é‚„æœ‰å¯äº¤æ›
function hasPossibleMoves(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(r<rows-1){ swapCellsSimple(r,c,r+1,c); if(checkMatches().length>0){ swapCellsSimple(r,c,r+1,c); return true;} swapCellsSimple(r,c,r+1,c);}
      if(c<cols-1){ swapCellsSimple(r,c,r,c+1); if(checkMatches().length>0){ swapCellsSimple(r,c,r,c+1); return true;} swapCellsSimple(r,c,r,c+1);}
    }
  }
  return false;
}

function swapCellsSimple(r1,c1,r2,c2){
  [board[r1][c1],board[r2][c2]]=[board[r2][c2],board[r1][c1]];
}

function gameOver(){
  alert("éŠæˆ²çµæŸï¼æœ€çµ‚å–µå—šå€¼ï¼š" + score);
}

initBoard();
</script>

</body>
</html>
